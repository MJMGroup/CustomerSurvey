<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Customer Database - MJM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f1; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; }
            .glass-panel { border: none !important; box-shadow: none !important; background: white !important; }
        }
    </style>
</head>
<body class="p-3 md:p-8">
    <div class="max-w-6xl mx-auto">
        
        <div class="no-print mb-6 px-2">
            <a href="report.html" class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-800 transition-all flex items-center gap-2">
                <span class="text-lg">‚Üê</span> Back to report home page
            </a>
        </div>

        <div class="glass-panel p-8 rounded-[2.5rem] mb-6 shadow-sm">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div>
                    <h1 class="text-2xl font-black text-slate-800 uppercase italic">üë• Customer Database</h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Master Profile Registry</p>
                </div>

                <div class="no-print flex gap-3 self-end md:self-center">
                    <button onclick="exportProfilesExcel()" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-md italic">
                        üì• Export Excel
                    </button>
                    <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-black transition-all shadow-md italic">
                        üñ®Ô∏è Print PDF
                    </button>
                </div>
            </div>
        </div>

        <div class="no-print mb-4 flex gap-2">
            <div class="relative flex-grow">
                <input type="text" id="search_cust" placeholder="SEARCH CUSTOMER BY NAME OR LOCATION..." 
                       class="w-full bg-white border-2 border-slate-200 rounded-2xl px-6 py-4 text-xs font-black outline-none focus:border-slate-800 transition-all uppercase shadow-sm">
            </div>
            <button onclick="filterProfiles()" class="bg-slate-800 text-white px-8 rounded-2xl font-black text-xs uppercase hover:bg-black transition-all shadow-md">
                Search
            </button>
        </div>

        <div class="glass-panel rounded-[2.5rem] overflow-hidden bg-white shadow-2xl border-2 border-slate-800">
            <div class="table-container">
                <table class="w-full text-left border-collapse min-w-[1000px]">
                    <thead class="bg-slate-50 border-b-2 border-slate-100">
                        <tr>
                            <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Customer Name</th>
                            <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Estate Location</th>
                            <th class="p-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">Area (Ha)</th>
                            <th class="p-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">Contact Number</th>
                            <th class="p-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">Survey Times</th>
                            <th class="p-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">Last Activity</th>
                            <th class="p-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody id="profile-table" class="divide-y divide-slate-100 text-xs font-bold text-slate-700 italic uppercase">
                        </tbody>
                </table>
            </div>
        </div>

        <p class="text-center text-[9px] font-black text-slate-300 uppercase tracking-[0.3em] mt-10 mb-20">MJM Database Management System ‚Ä¢ Confidential</p>
    </div>

    <script>
        let allProfiles = [];

        async function fetchProfiles() {
            // Updated to fetch 'contact_no' as requested
            const { data: logs, error } = await _supabase
                .from('ffb_logs')
                .select('customer_name, location, area_size, created_at, notes, contact_no')
                .order('created_at', { ascending: false });

            if(error) return alert("Database Error: " + error.message);

            const map = new Map();
            
            for (const log of logs) {
                if (!map.has(log.customer_name)) {
                    // Priority 1: Check the new dedicated 'contact_no' column
                    let contact = log.contact_no;

                    // Priority 2: Fallback to extracting from Notes for old data
                    if (!contact || contact.trim() === "" || contact.toLowerCase() === "n/a") {
                        const noteParts = log.notes ? log.notes.split('|') : [];
                        const found = noteParts.find(p => p.toLowerCase().includes('contact:'));
                        contact = found ? found.split(':')[1].trim() : 'N/A';
                    }
                    
                    map.set(log.customer_name, {
                        customer_name: log.customer_name || 'UNKNOWN',
                        location: log.location || '-',
                        area_size: log.area_size || '0',
                        contact_number: contact,
                        survey_count: 1,
                        last_activity: log.created_at
                    });
                } else {
                    const existing = map.get(log.customer_name);
                    existing.survey_count += 1;
                }
            }
            
            allProfiles = Array.from(map.values());
            renderProfiles(allProfiles);
        }

        function renderProfiles(data) {
            const container = document.getElementById('profile-table');
            if(data.length === 0) {
                container.innerHTML = `<tr><td colspan="7" class="p-20 text-center text-slate-300 uppercase font-black tracking-widest">No matching records found</td></tr>`;
                return;
            }

            container.innerHTML = data.map((x) => `
                <tr class="hover:bg-slate-50 transition-all border-b border-slate-50">
                    <td class="p-5 font-black text-slate-900 tracking-tighter">${x.customer_name}</td>
                    <td class="p-5 text-slate-500 font-bold">${x.location}</td>
                    <td class="p-5 text-center text-slate-400 font-black">${x.area_size}</td>
                    <td class="p-5 text-center text-slate-600 font-bold">${x.contact_number}</td>
                    <td class="p-5 text-center">
                        <span class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg text-[10px] font-black">${x.survey_count}</span>
                    </td>
                    <td class="p-5 text-center text-slate-800 font-black">${new Date(x.last_activity).toLocaleDateString('en-GB')}</td>
                    <td class="p-5 text-center no-print">
                        <button onclick="viewDetails('${encodeURIComponent(x.customer_name)}')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-[9px] font-black uppercase italic tracking-tighter hover:bg-black transition-all">View Detail</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewDetails(name) {
            window.location.href = `report-surveys.html?search=${name}`;
        }

        function filterProfiles() {
            const term = document.getElementById('search_cust').value.toLowerCase();
            const filtered = allProfiles.filter(x => 
                (x.customer_name && x.customer_name.toLowerCase().includes(term)) ||
                (x.location && x.location.toLowerCase().includes(term))
            );
            renderProfiles(filtered);
        }

        function exportProfilesExcel() {
            if(allProfiles.length === 0) return alert("No data to export");
            const exportData = allProfiles.map(x => ({
                'Customer Name': x.customer_name,
                'Location': x.location,
                'Area (Ha)': x.area_size,
                'Contact': x.contact_number,
                'Surveys': x.survey_count,
                'Last Activity': new Date(x.last_activity).toLocaleDateString('en-GB')
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Profiles");
            XLSX.writeFile(wb, `MJM_Database_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        window.onload = fetchProfiles;
    </script>
</body>
</html>