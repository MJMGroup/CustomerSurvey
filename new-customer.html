<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Customer - MJM Survey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .soil-box { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 800; color: #1e293b; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h1 class="text-2xl font-black text-slate-700 uppercase italic tracking-tighter">ðŸŒ± New Customer</h1>
            <a href="index.html" class="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-widest bg-slate-50 px-3 py-2 rounded-lg shadow-sm border">Back to Menu</a>
        </div>

        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl border border-slate-200 mb-8">
            <div id="form-header" class="mb-6 p-4 rounded-2xl text-white font-bold text-center text-lg flex justify-between items-center bg-emerald-600">
                <span>New Customer Registration</span>
                <span id="log-id" class="text-xs bg-black/20 px-3 py-1 rounded-full font-mono"></span>
            </div>

            <form id="ffb-form" class="space-y-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Customer / Company Name</label>
                        <input type="text" id="cust_name" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Contact Number</label>
                        <input type="text" id="contact_ui" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    
                    <div class="p-4 bg-slate-50 border border-slate-100 rounded-xl space-y-2">
                        <label class="block text-sm font-bold text-slate-700">Type of Soil</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 text-xs font-bold uppercase cursor-pointer">
                                <input type="checkbox" id="soil_mineral" class="w-5 h-5 accent-emerald-600"> Mineral Soil Area
                            </label>
                            <label class="flex items-center gap-2 text-xs font-bold uppercase cursor-pointer">
                                <input type="checkbox" id="soil_peat" class="w-5 h-5 accent-emerald-600"> Peat Soil Area
                            </label>
                        </div>
                    </div>

                    <div class="p-4 bg-blue-50 border border-blue-100 rounded-xl">
                        <label class="block text-sm font-bold text-blue-900 mb-2">Currently supply to our collection center?</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="soil-box"><input type="checkbox" name="mjm_center" value="MJM Bekenu" class="w-4 h-4 accent-blue-600"> MJM Bekenu</label>
                            <label class="soil-box"><input type="checkbox" name="mjm_center" value="MJM Kejapil" class="w-4 h-4 accent-blue-600"> MJM Kejapil</label>
                            <label class="soil-box"><input type="checkbox" name="mjm_center" value="MJM Pelapi" class="w-4 h-4 accent-blue-600"> MJM Pelapi</label>
                            <label class="soil-box"><input type="checkbox" name="mjm_center" value="MJM Tegageng" class="w-4 h-4 accent-blue-600"> MJM Tegageng</label>
                            <label class="soil-box"><input type="checkbox" name="mjm_center" value="MJM Kerabungan" class="w-4 h-4 accent-blue-600"> MJM Kerabungan</label>
                            <label class="soil-box"><input type="checkbox" name="mjm_center" value="MJM POM" class="w-4 h-4 accent-blue-600"> MJM (Palm Oil Mill)</label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Total Area (Ha)</label>
                            <input type="number" id="area_size_ui" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" step="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Estimated Monthly Supply Tonnage (mt)</label>
                            <input type="number" id="tonnage_ui" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" step="0.01">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Estate Location</label>
                            <input type="text" id="loc_ui" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Google Location Link</label>
                            <input type="text" id="google_ui" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" placeholder="https://maps.google.com/...">
                        </div>
                    </div>

                    <div class="space-y-3 mt-6">
                        <label class="block text-sm font-bold text-slate-700">Currently supply to other ramp?</label>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="b1" placeholder="Name of mill / collection center" class="p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                            <input type="number" id="p1" placeholder="Offered Price (RM/mt)" class="p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="b2" placeholder="Name of mill / collection center" class="p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                            <input type="number" id="p2" placeholder="Offered Price (RM/mt)" class="p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="b3" placeholder="Name of mill / collection center" class="p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                            <input type="number" id="p3" placeholder="Offered Price (RM/mt)" class="p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100">
                    <button type="submit" id="submit-btn" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-xl hover:bg-emerald-700 transition-all">Save New Customer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.getElementById('log-id').innerText = "REF-" + Date.now().toString().slice(-6);

        document.getElementById('ffb-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const user = await checkAuth();
            if (!user) return;

            const custName = document.getElementById('cust_name').value;
            const contact = document.getElementById('contact_ui').value;
            const area = document.getElementById('area_size_ui').value || 0;
            const tonnage = document.getElementById('tonnage_ui').value || 0;
            const googleLink = document.getElementById('google_ui').value;
            const locationTxt = document.getElementById('loc_ui').value;
            
            const soilMineral = document.getElementById('soil_mineral').checked ? "Mineral" : "";
            const soilPeat = document.getElementById('soil_peat').checked ? "Peat" : "";
            const soilType = [soilMineral, soilPeat].filter(Boolean).join(" & ") || "Not Specified";

            // Collect MJM Centers
            const mjmCenters = [];
            document.querySelectorAll('input[name="mjm_center"]:checked').forEach(cb => mjmCenters.push(cb.value));

            // Collect competitor data
            const competitors = [];
            for(let i=1; i<=3; i++) {
                const name = document.getElementById('b'+i).value;
                const price = document.getElementById('p'+i).value;
                if(name) competitors.push(`${name} (@RM${price}/mt)`);
            }

            const finalLocation = `${locationTxt} (Link: ${googleLink})`;
            // Updated notes to include MJMSentTo
            const finalNotes = `New Customer Entry. Contact: ${contact}. Soil: ${soilType}. Est Monthly: ${tonnage}mt. MJMSentTo: ${mjmCenters.join(',')}. Competitors: ${competitors.join(', ') || 'None'}`;

            const payload = { 
                customer_name: custName, 
                location: finalLocation, 
                area_size: area,
                tonnage: tonnage, 
                log_type: 'New Customer', 
                notes: finalNotes, 
                branch: userBranch, 
                pic_email: user.email 
            };

            const { error } = await _supabase.from('ffb_logs').insert([payload]);

            if (error) {
                alert("Error: " + error.message);
            } else {
                alert("New Customer Registered Successfully!");
                window.location.href = 'index.html';
            }
        };

        window.onload = async () => {
            await checkAuth();
        };
    </script>
</body>
</html>
