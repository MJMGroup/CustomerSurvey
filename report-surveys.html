<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Survey Logs - MJM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f1; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        #details-modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease-out; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <div class="no-print flex justify-between items-center mb-6">
            <a href="report.html" class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-800 transition-all">‚Üê Back to Dashboard</a>
        </div>

        <div class="no-print flex flex-col md:flex-row justify-between items-center mb-6 glass-panel p-6 rounded-[2rem] gap-4 shadow-sm">
            <div>
                <h1 class="text-2xl font-black text-slate-800 uppercase italic">üìù Master Survey Logs</h1>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Database Record Manager</p>
            </div>
            <div class="flex gap-2">
                <input type="date" id="filter_start" class="p-2 border rounded-xl font-bold text-xs outline-none">
                <input type="date" id="filter_end" class="p-2 border rounded-xl font-bold text-xs outline-none">
                <button onclick="fetchData()" class="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold text-xs uppercase hover:bg-black transition-all">Filter</button>
            </div>
        </div>

        <div class="glass-panel rounded-[2.5rem] overflow-hidden bg-white shadow-2xl border-2 border-slate-800 mb-20">
            <div class="table-container">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b">
                        <tr>
                            <th class="p-4 text-[10px] font-black text-slate-400 uppercase">Date</th>
                            <th class="p-4 text-[10px] font-black text-slate-400 uppercase">Customer</th>
                            <th class="p-4 text-[10px] font-black text-slate-400 uppercase">Follow Up</th>
                            <th class="p-4 text-center text-[10px] font-black text-slate-400 uppercase">Action</th>
                        </tr>
                    </thead>
                    <tbody id="log-list" class="text-xs font-bold text-slate-700 divide-y divide-slate-100 italic"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl rounded-[2.5rem] overflow-hidden shadow-2xl transform translate-y-8 transition-all">
            <div class="p-8 bg-slate-50 border-b flex justify-between items-start">
                <div>
                    <span id="modal-type" class="inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest mb-2 bg-blue-100 text-blue-700"></span>
                    <h3 id="modal-title" class="text-2xl font-black text-slate-800 uppercase tracking-tighter"></h3>
                </div>
                <button onclick="closeModal('details-modal')" class="p-3 bg-white border rounded-2xl hover:bg-slate-100">‚úï</button>
            </div>
            <div id="modal-body" class="p-8 max-h-[60vh] overflow-y-auto space-y-8 bg-white"></div>
            <div class="p-6 bg-slate-50 border-t flex justify-center gap-3">
                <button id="btn-edit-mode" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-blue-700 transition-all">Edit Record</button>
                <button onclick="closeModal('details-modal')" class="px-8 py-3 bg-slate-800 text-white rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-black transition-all">Close Viewer</button>
            </div>
        </div>
    </div>

    <script>
        let currentRecords = [];
        let activeId = null;

        async function fetchData() {
            const start = document.getElementById('filter_start').value;
            const end = document.getElementById('filter_end').value;
            const { data, error } = await _supabase.from('ffb_logs').select('*').gte('created_at', start + 'T00:00:00').lte('created_at', end + 'T23:59:59').order('created_at', { ascending: false });
            if(error) return alert(error.message);
            currentRecords = data;
            renderTable();
        }

        function renderTable() {
            const list = document.getElementById('log-list');
            list.innerHTML = currentRecords.map((x, i) => {
                let fText = "NO", fClass = "text-slate-300";
                if (x.follow_up_action === "Closed") { fText = "CLOSED CASE"; fClass = "text-green-600"; }
                else if (x.follow_up_action !== "No" && x.follow_up_action) { fText = "YES"; fClass = "text-amber-600"; }
                return `<tr class="hover:bg-slate-50 transition-all border-b"><td class="p-4 text-[10px] text-slate-400">${new Date(x.created_at).toLocaleDateString('en-GB')}</td><td class="p-4 uppercase">${x.customer_name || ''}</td><td class="p-4 font-black ${fClass}">${fText}</td><td class="p-4 text-center"><button onclick="showDetails(${i})" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase italic">Details</button></td></tr>`;
            }).join('');
        }

        async function showDetails(index) {
            const item = currentRecords[index];
            activeId = item.id;
            const notes = item.notes || "";

            // CRITICAL FIX: Fetch profile data from 'customer_profile' table
            const { data: profile } = await _supabase
                .from('customer_profile')
                .select('*')
                .eq('full_name', item.customer_name)
                .maybeSingle();

            const getVal = (keywords) => {
                const parts = notes.split(' | ');
                for (let word of keywords) {
                    const found = parts.find(p => p.toLowerCase().includes(word.toLowerCase() + ':'));
                    if (found) return found.split(':')[1].trim();
                }
                return null;
            };

            // Link logic for Customer Profile data
            const displayArea = profile?.total_area || "0";
            const displayContact = profile?.contact_number || "No Data";
            const displayType = profile?.estate_type || "No Data";

            document.getElementById('modal-title').innerText = item.customer_name;
            document.getElementById('modal-type').innerText = item.log_type;

            const section1 = `
                <div>
                    <h4 class="text-[10px] font-black text-slate-800 uppercase tracking-widest mb-4 flex items-center gap-2"><span class="w-5 h-5 rounded bg-slate-800 text-white flex items-center justify-center text-[9px]">1</span> Customer Profile</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-50 border rounded-xl"><span class="block text-[8px] font-black text-slate-400 uppercase">Customer Name</span><p class="text-xs font-bold uppercase">${item.customer_name}</p></div>
                        <div class="p-3 bg-slate-50 border rounded-xl"><span class="block text-[8px] font-black text-slate-400 uppercase">Estate Location</span><p class="text-xs font-bold">${item.location || 'N/A'}</p></div>
                        <div class="p-3 bg-slate-50 border rounded-xl"><span class="block text-[8px] font-black text-slate-400 uppercase">Estate Total Area</span><p class="text-xs font-bold">${displayArea} Ha</p></div>
                        <div class="p-3 bg-slate-50 border rounded-xl"><span class="block text-[8px] font-black text-slate-400 uppercase">Contact Number</span><p class="text-xs font-bold">${displayContact}</p></div>
                        <div class="p-3 bg-slate-50 border rounded-xl"><span class="block text-[8px] font-black text-slate-400 uppercase">Type of Estate</span><p class="text-xs font-bold">${displayType}</p></div>
                        <div class="p-3 bg-slate-50 border rounded-xl"><span class="block text-[8px] font-black text-slate-400 uppercase">Branch & PIC</span><p class="text-xs font-bold uppercase">${item.branch || '-'} / ${item.pic_email ? item.pic_email.split('@')[0] : '-'}</p></div>
                    </div>
                </div>`;

            let qSet = [];
            const type = item.log_type.toLowerCase();
            if (type.includes('new')) {
                qSet = [{ q: "Estimated Monthly Tonnage (mt)", a: (item.tonnage || "0") + " mt" }, { q: "MJM Sent To", a: getVal(["MJMSentTo"]) || "N/A" }, { q: "Competitors", a: getVal(["Competitors"]) || "N/A" }];
            } else {
                qSet = [{ q: "Service Rating (1-5)", a: getVal(["Rating"]) || "N/A" }, { q: "Staff Professionalism", a: getVal(["Staff"]) || "N/A" }, { q: "Issues Faced", a: getVal(["Issues"]) || "None" }];
            }

            const section2 = `<div><h4 class="text-[10px] font-black text-slate-800 uppercase tracking-widest mb-4 flex items-center gap-2"><span class="w-5 h-5 rounded bg-blue-600 text-white flex items-center justify-center text-[9px]">2</span> Survey Summary</h4><div class="p-5 bg-blue-50/50 rounded-2xl border border-blue-100 space-y-4">${qSet.map(s => `<div><p class="text-[8px] font-black text-blue-400 uppercase">${s.q}</p><p class="text-xs font-bold text-slate-700">${s.a}</p></div>`).join('')}</div></div>`;

            document.getElementById('modal-body').innerHTML = section1 + section2;
            document.getElementById('btn-edit-mode').onclick = () => openEdit(item);

            const modal = document.getElementById('details-modal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('translate-y-8'); }, 10);
        }

        function openEdit(item) {
            document.getElementById('modal-body').innerHTML = `<div class="space-y-4"><p class="text-[10px] font-black text-blue-600 uppercase mb-4 italic">Update Database Record</p><div><label class="text-[8px] font-black uppercase">Customer Name</label><input type="text" id="e_name" value="${item.customer_name}" class="w-full p-2 border rounded font-bold text-xs"></div><div><label class="text-[8px] font-black uppercase">Status</label><select id="e_status" class="w-full p-2 border rounded font-bold text-xs"><option value="No">No Follow Up</option><option value="Pending">Pending</option><option value="Closed">Closed</option></select></div><button onclick="saveEdit()" class="w-full bg-green-600 text-white py-3 rounded-xl font-black text-xs uppercase shadow-lg hover:bg-green-700 transition-all">Save To Database</button></div>`;
            document.getElementById('e_status').value = item.follow_up_action || 'No';
        }

        async function saveEdit() {
            const updates = { customer_name: document.getElementById('e_name').value, follow_up_action: document.getElementById('e_status').value };
            const { error } = await _supabase.from('ffb_logs').update(updates).eq('id', activeId);
            if(error) alert(error.message);
            else { alert("Database Updated Successfully!"); closeModal('details-modal'); fetchData(); }
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.add('opacity-0');
            m.querySelector('.modal-content').classList.add('translate-y-8');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        window.onload = () => {
            const now = new Date();
            const toISO = (d) => new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().split('T')[0];
            document.getElementById('filter_start').value = toISO(new Date(now.getFullYear(), now.getMonth(), 1));
            document.getElementById('filter_end').value = toISO(new Date(now.getFullYear(), now.getMonth() + 1, 0));
            fetchData();
        };
    </script>
</body>
</html>